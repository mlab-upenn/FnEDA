\documentclass[openany]{now} % creates the journal version
% \documentclass{now}  % creates the book pdf version

% the now document class sets various dimensions, so be sure to *not* set
% or alter dimensions in your latex code.
% be sure to remove all manual formatting commands such \newpage, \clearpage.
\usepackage[english]{babel}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{graphicx}
\usepackage[colorinlistoftodos]{todonotes}
\newcommand{\figref}[1]{Fig.~\ref{fig:#1}}
\newcommand{\Hao}[1]{$\clubsuit$\footnote{HAO: #1}}
% a few definitions that are *not* needed in general:
\newcommand{\ie}{\emph{i.e.}}
\newcommand{\eg}{\emph{e.g.}}
\newcommand{\etc}{\emph{etc}}
\newcommand{\now}{\textsc{now}}
\usepackage{times}
\usepackage[tight,footnotesize]{subfigure}
%\usepackage{bibspacing}
%\setlength{\bibspacing}{\baselineskip}

%%%%%%%%%%%%%%%%%%%%%%%%
\usepackage{verbatim}
%\usepackage{babel}  
\usepackage{listings}
\usepackage{comment} 
\usepackage{multirow}

%% Math Packages %%%%%%%%%%%%
\usepackage{amsthm}
\usepackage{amsfonts}

\title{Physiological Modeling in Medical Device Software Development and Certification}
\author{
Zhihao Jiang \\
University of Pennsylvania\\
zhihaoj@seas.upenn.edu\and
Rahul Mangharam \\
University of Pennsylvania\\
rahulm@seas.upenn.edu}

\begin{document}

% the following settings can be set or left blank at first
\copyrightowner{Z.~Jiang and R.~Mangharam}
% \volume{1}
% \issue{3}
% \pubyear{2014}
% \copyrightyear{2013}
% \isbn{978-0521833783}
% \doi{1234567890}
% \firstpage{23}
% \lastpage{94}

\frontmatter  % title page, contents, catalog information

\maketitle

\tableofcontents

\mainmatter

\begin{abstract}

\end{abstract}

\chapter{Introduction}
\begin{itemize}
  \item Why does the safety of the medical devices, the software component in particular, so important?
  \item What is the difference between software specification and software requirement?
  \item What is the current practice to ensure software safety? 
  
  \item What's the problem with the current practice?
  \item Why do we need closed-loop verification?
  
  \item What is the benefit of using model-based design?
  \item Can we use model-based design for closed-loop verification?
  \item How much confidence can model-based closed-loop verification provide?
  \item How to validate a physiological model? Validated in what sense?
  \item How do we model the physiological environment that the device operates in? What are the challenges?
  \item What are the current practice for physiological modeling?
  \item What are the differences if we would like to use the models for closed-loop verification of medical devices?
	\item What are the different forms of model-based closed-loop verification?

    \item How to maintain safety guarantees through out the development process?
    \item What are possible problems that may arise during each steps?
    \item How can model-based design help during certification?
%     \item The pacemaker example

%     \begin{itemize}
%     	\item What are the steps of a possible model-based development process?
%         \item Heart Modeling

%         \begin{itemize}
%         	\item How to encode domain knowledge into the physiological models?
%         \end{itemize}
%         \item Model Validation
        
%         \begin{itemize}
%         	\item 
%         \end{itemize}
        
%         \item Abstract model checking
        
%           \begin{itemize}
%           	\item How to use models to cover environmental conditions specified in the physiological requirements, that the device may encounter?
%             \item What are the physiological requirements? What form should they be?
%             \item Can model checking find violations that testing cannot find?
%             \item What are the effects of adding new features? Can they disrupt the safety properties that the previous device hold?
%             \item What is the model complexity requirements for each physiological requirement? When and how to refine the environment model?
%             \item Exploring the whole state space sounds great. What are the limitations of model checking?
%           \end{itemize}
%         \item Model Simulation
        	
%           \begin{itemize}
%           	\item How can model simulation complement model checking?
%             \item How to model the interactions between the environment and the device?
           
%           \end{itemize}
        
%         \item Physical Testing
        
%           \begin{itemize}
%           	\item Is it necessary to make physical platform for the enviornment? What's the benefit?
%             \item Is there real-time requirements?
%             \item How to generate tests? What does closed-loop testing mean?
%             \item How much coverage can it achieve? How to quantify?
%           \end{itemize}
%         \item Traceability
        
%           \begin{itemize}
        
%             \item How to maintain safety confidence throughout the development process? 
%             \item What is the current practice?
%             \item Can it be automated?
%             \item How much confidence can it provide?
%           \end{itemize}
        
%         \item Certification
        
%           \begin{itemize}
%           	\item Can model-based closed-loop verification provide more safety guarantee than current practice? How much?
%           \end{itemize}
%     \end{itemize}
\end{itemize}


\begin{figure}[!b]
		\centering
		\includegraphics[width=0.8\textwidth]{figs/Fig1.png}
		%\vspace{-5pt}
		\caption{\small Scope of the survey}
		  %\vspace{-15pt}
		\label{fig:scope}
\end{figure}
\begin{figure}[!b]
		\centering
		\includegraphics[width=0.5\textwidth]{figs/devices.png}
		%\vspace{-5pt}
		\caption{\small List of Cardiac devices}
		  %\vspace{-15pt}
		\label{fig:devices}
\end{figure}

\section{Medical Device Software Safety: Current Practice*}
\begin{itemize}
    \item What are the problems of the certification process?
    \item What are the safety proofs that the FDA receive?
    \item What is Open-loop Testing? What is the problem with it?
    \item What is the limitation of the clinical trials?
    
\end{itemize}

\section{Model-based Closed-loop Verification of Medical Device Software}
\begin{itemize}
	\item Can we replace real patient with models? What are the challenges? How much guarantee can we provide?
    \item In what forms can model-based closed-loop verification performed?
    \item What are the different requirements for the environment model in these forms?
\end{itemize}

\section{Traditional Physiological Modeling**}
\begin{itemize}
	\item Where are the applications of those physiological models?
    \item What are the key perspectives that the modeling should focus on?
    \item Can we use these models for model-based closed-loop verification?
    \item What are the difference between these applications?
\end{itemize}

\section{Modeling Perspectives**}
\begin{itemize}
	\item Complexity
    \item Generality
    \item Validation
\end{itemize}

\chapter{Understanding the Physiological Environment}
\begin{itemize}
	\item What is the environment that the pacemaker works in?
    \item How does the environment work?
    \item How can the pacemaker interact with the environment?
    \item What are the diseases that the pacemaker can treat?
\end{itemize}

Medical devices interact with the human body and the physiological requirements are specified according to the pre- and post- conditions of the patient. The knowledge of the dynamics of the human physiology and how it interacts with the devices is essential for 1) constructing physiological models; 2) understanding and encoding physiological requirements; 3) evaluating the closed-loop interactions between the human body and the devices. It is important to understand the physiological environment of the device at the level that 1) unnecessary details unrelated to the interaction between the device and the human are abstracted away, and 2) essential details required to differentiate different patient conditions are maintained.

\section{Heart, Arrhythmia and Pacemaker}
The heart generates periodic electrical impulses to control heart rates according to physiological needs. These impulses conduct through the heart, triggering coordinated muscle contractions and pump blood to the rest of the body. The underlying pattern and timing of these impulses determine the heart's rhythm and are the key to proper heart functions. Derangements in this rhythm are referred to as \emph{arrhythmia}, which impair the heart's ability to pump blood and compromise the patients' health. Arrhythmia are categorized into so-called \textsf{Tachycardia} and \textsf{Bradycardia}. Tachycardia features undesirable fast heart rate which results in inefficient blood pumping. Bradycardia features slow heart rate which results in insufficient blood supply. Bradycardia are due to failure of impulse generation with anomalies in the SA node, or failure of impulse propagation where the conduction from atria to the ventricles is delayed or blocked. 

The implantable cardiac pacemaker is a rhythm management device designed to treat bradycardia. A typical dual chamber pacemaker has two leads inserted into the heart through the veins which can measure the local electrical activities of the right atrium and right ventricle, respectively. According to the timing between sensed impulses the pacemaker can deliver electrical pacing to the corresponding chamber to maintain proper heart rhythm.

\section{Cellular Level ElectroPhysiology}
The contraction of heart muscles are triggered by external voltage applied to the cell. After the activation, a transmembrane voltage change over time can be sensed due to ion channel activities, which is referred to as an Action Potential (\figref{refractory}(a)). The upstroke of the action potential is called depolarization, during which the muscle will contract. The voltage change caused by the depolarization will depolarize the cells nearby, which causes an activation wave across the heart. After the depolarization there is a refractory period during which the cell recovers to the pre-excitation state and the voltage drops down to the resting potential. The refractory period can be divided into \emph{Effective Refractory Period (ERP)} and \emph{Relative Refractory Period (RRP)} (\figref{refractory}(b)). During ERP, the cell cannot be depolarized due to the lack of the ion. As the result, the activation wave will be "blocked" at the tissue during ERP (\figref{refractory}(c1)). During RRP, the cell is partially recovered and the cell can be depolarized. However, the new action potential generated by the depolarization will have different morphology, thus affecting the refractory periods of the tissue and conduction delay of the activation wave (\figref{refractory}(c2)). \figref{refractory}(c1)-(c3) show the action potential shape change and corresponding timing change in refractory periods when the cell is activated at time stamp $t1$, $t2$, $t3$ after the initial activation $t0$. 

\begin{figure}[!t]
\center
%\vspace{-10pt}
\includegraphics[width=0.45\textwidth]{figs/refractory.png}
%\vspace{-10pt}
\caption{(a) The generation of Action potential; (b) Action potential; (c1) The second activation arrived during ERP; (c2) Arrived during RRP; (c3) Arrived after refractory.}
\label{fig:refractory}
%\vspace{-10pt}
\end{figure} 

\section{Electrical conduction system of the heart}
Heart tissue with different timing parameters assemble the electrical conduction system to ensure coordinated contraction of the heart. First, specialized tissue at the Sinoatrial (SA) node periodically and spontaneously self-depolarizes. This is controlled by the nervous system and the SA node is the primary and natural pacemaker of the heart. The activation signal then travels through both atria, causing contraction and pushes blood into the ventricles. Then the activation is delayed at the Atrioventricular (AV) node which allows the ventricles to fill fully. The fast-conducting His-Purkinje system then spreads the activation signal within both the ventricles. The simultaneous contraction of the ventricle muscles will push the blood out of the heart.
\begin{figure*}[!t]
\centering
		\subfigure [\small]{			
		\includegraphics[width=0.3  \textwidth]{figs/probes.png}
		\label{fig:probes}
		} 
%	\hspace{.1in}%
		
		\subfigure [\small] 
		{
		\includegraphics[width=0.2\textwidth]{figs/egm.png}
		\label{fig:egm}
		} 
%\vspace{-10pt}
\caption{\small (a) Node automaton. Dotted transition is only valid for pacemaker tissue like SA node; (b) Path automaton; (c) Model of the electrical conduction system of the heart using a network of node \& path automata~\cite{vhm_ecrts10}.}
%\vspace{-15pt}
\end{figure*} 

\section{Electrophysiological Testing}
The electrical activities of the heart can be monitored and used to diagnose arrhythmia. The most well-known method is Electrocardiogram (ECG or EKG), which measure the integration of electrical activities of the heart measured along different axis on the body surface. The electrical activities can also be measured by inserting electrodes through the vein into the heart. The electrodes are placed against the inside heart wall and localized electrical activities can be measured. (\figref{probes}) Physicians can also deliver pacing sequence through the electrodes to explore the heart conditions. This procedure is referred to as Electrophysiological (EP) Testing and the signals are referred to as electrograms (EGMs) (\figref{egm}). 

Implantable pacemakers and ICDs follow the principle of EP testing. For a dual chamber pacemaker, two leads are inserted into the right atrium and right ventricle, respectively. The pacemaker senses the intrinsic generation and conduction of the electrical signals in the two chambers and deliver electrical pacing when the heart rate and/or atria-to-ventricles conduction interval are abnormal.

\Hao{A figure for heart and pacemaker}

\chapter{Modeling the Physiological Environment}
\begin{itemize}
	\item How to encode domain knowledge of the physiological environment into models?
    \item What are the applications that the models will be used?
    \item What are the differences in terms of environment models between model checking and simulation?
    \item How to balance complexity and expressiveness of the model?
\end{itemize}
Models (especially environment models) should be designed in accordance with their respective applications. During model-based development of medical devices, the environment model can be used for 1) closed-loop testing and 2) closed-loop model checking. Each application has different focus thus has very distinct requirements for the models. These requirements will affect the basic properties of the models, including 1) model complexity, 2) model identifiability etc. 

\textbf{Model Complexity} is generally measured in terms of the size of state space and/or computation complexity of state transitions, which affects the computation cost (memory and time) for closed-loop verification. The complexity requirements of an environment model is usually determined by 1) The complexity of the interactions between the environment model and the system model and 2) The complexity of the environment condition specified in the physiological requirements.

\textbf{Model Identifiability} is a metric of the feasibility/difficulty of identifying model parameters from data. It affects the validity of the model which is a key element for closed-loop verification. Model identifiability is generally related to 1) Model complexity and 2) Data availability/quality. In general, the more complex the model structure is, the harder the model can be fully identified. For physiological modeling, the data availability is almost always an issue.

In the following sections, we demonstrate how to construct heart models for closed-loop verification of implantable pacemaker. Note that for two different applications the models are constructed differently as we address their respective requirements for environment models. 


\section{Heart Models For Closed-loop Testing}
\begin{itemize}
	\item Why the models at this level have to be deterministic? Where can they be used?
    \item How electrophysiology reflects the functions of the heart?
    \item How to encode these knowledge into models?
    \item Why VHM has the right level of details for pacemaker verification?
    \item How VHM interacts with pacemaker?
    
\end{itemize}
During closed-loop testing, the devices interact with the environment (or its models) under different environmental conditions. The closed-loop executions are monitored and violations of safety/efficacy requirements are reported. In model-based closed-loop testing, the environment models are expected to mimic the behaviors of actual environment and its interaction with the device. Thus the environment models are in general deterministic so that the execution traces are reproducible. Complex dynamics during state transitions also need to be captured to validate violations within longer executions traces. 

\subsection{Modeling Philosophy}

\textbf{Interface to the device: }The pacemaker can only sense and actuate from two locations within the heart, the spatial fidelity requirement for the heart model is thus low. The diagnosis of heart conditions only relies on the timing of the electrical events, thus the behaviors of the model can be reduced to timing only, if a temporal model of the heart is rich enough to represent majority of heart conditions. \\
\textbf{Model expressiveness: }Electrophysiology (EP) is an active field in cardiology based on the fact that the mechanical functions of the heart are largely correlated with the electrical activities. During an EP testing procedure, the physicians diagnose heart conditions by examining the patterns and intervals of local electrical activations (temporal) measured from electrodes placed into different locations of the heart (spatial). 

Based on the analysis above, an EP-based spatial and temporal model of the heart is capable of representing the electrical behaviors of different heart conditions, and more importantly, their interaction with a pacemaker. 

\subsection{Heart Model Components}
We introduce the model components that can be used to configure heart models corresponding to different heart conditions. As introduced in Chapter 2, the action potential of a heart tissue has 3 timing periods during which the tissue responds to external electrical stimuli differently. We use an extended timed-automata formulation (\cite{timed_automata}) to model the timing behaviors of a heart tissue during each cycle. We refer the tissue model as \emph{Node automaton} and \figref{node_automata} shows the structure of a node automaton $i$. 3 states correspond to 3 timing periods of the action potential. From \textsf{Rest} state, the node can either self activate or activated by external stimuli (Act\_node) and go to \textsf{ERP} state. During \textsf{ERP} state the node does not respond to external stimuli (blocked). During \textsf{RRP} state, the node can still be activated and go to \textsf{ERP} state, however the ERP period and the conduction delay of the tissue are affected by the "earliness" of the activation arrived during the RRP period, which is tracked by a shared variable $C(i)$. The new ERP period is determined by a function over clock value $g(f(t))$ which mimic the beat-to-beat dynamics described in \cite{josephson}. The function $g$ and $f$ are given by:
\begin{equation} \label{factor}
						f(t) = 1-t/Trrp
						\end{equation}
and
%  The AV node has a different profile than the other tissue. The ERP period increases rather than decreases when activated during its RRP (~\cite{josephson}).
\begin{equation} \label{earliness_noAV}
						g(x) = \left\{
						\begin{array}{lr}
						
						T_{min}+(1-(1-x)^3)\cdot (T_{max}-T_{min}), i=AV\\
						T_{min}+(1-x^3)\cdot (T_{max}-T_{min}),i\neq AV
			
						
						\end{array}
						\right.
						\end{equation}  
where $T_{min}$ and $T_{max}$ are the minimum and maximum value for \emph{Terp} of the tissue.
\begin{figure*}[!t]
\centering
		\subfigure [\small]{			
		\includegraphics[width=0.35\textwidth]{figs/node_aut.png}
		\label{fig:node_automata}
		} 
%	\hspace{.1in}%
		\subfigure [\small] 
		{
		\includegraphics[width=0.35\textwidth]{figs/path_aut.png}
		\label{fig:path_automata}
		} 
		\subfigure [\small] 
		{
		\includegraphics[width=0.2\textwidth]{figs/gen_setup.png}
		\label{fig:general_setup}
		} 
\label{fig:h_automatas}
%\vspace{-10pt}
\caption{\small (a) Node automaton. Dotted transition is only valid for pacemaker tissue like SA node; (b) Path automaton; (c) Model of the electrical conduction system of the heart using a network of node \& path automata ~\cite{vhm_ecrts10}.}
%\vspace{-15pt}
\end{figure*} 

Due to the limited number of observable points within the heart, modeling every tissue of the heart and its full anatomy is unnecessary and unfeasible. In our heart models, only self-activating tissue and key hubs of the electrical conduction system are modeled as node automata. The electrical conduction through the tissue between nodes are abstracted using \emph{path automata}. The path automata can be used to represent structural or topological (functional) electrical connections between nodes. \figref{path_automata} shows a path automaton connecting node a and b.

The initial state of a path automaton is \emph{Idle}, which corresponds to no conduction. The states corresponding to the two conduction directions are named after the physiological terms: Antegrade (Ante) and Retrograde (Retro). These states can be intuitively described as forward and backward conductions. If \emph{Act\_path} event is received from one of the nodes connected to it, the a transition to \emph{Ante} or \emph{Retro} state correspondingly will occur in the path automaton. At the same time the clock invariant of the state is modified according to the shared variable \emph{C(a/b)}. This corresponds to the change of the conduction delay that is caused by the early activation. Similar to node automaton, the changing trend is extracted from clinical data and the function $h$ is defined as:
\begin{equation} 
						h(c) = \left\{
						\begin{array}{lr}
						
						path\_len/v\cdot (1+3c), i=AV\\
						path\_len/v\cdot (1+3c^2), i\neq AV
						\end{array}
						\right.
						\end{equation}
where $path\_len$ denotes the length of the path and $v$ is the conduction velocity.

After \emph{Tante} or \emph{Tretro} time expires, the path automaton sends out \emph{Act\_node(b)} or \emph{Act\_node(a)} respectively. A transition to \emph{Conflict} state occurs followed by the transition to \emph{Idle} state. The intermediate state \emph{Conflict} is designed to prevent back-flow, where the path is activated by the node \emph{b} it has just activated. If during \emph{Ante} or \emph{Retro} state another \emph{Act\_path} event is received from the other node connected to the path automaton, a transition to \emph{Double} state will occur, corresponding to the two-way conduction. In this case, the activation signals eventually cancel each other and the transition to \emph{Idle} state is taken.

\subsection{Modeling the Electrical Conduction System}
The node and path automata are the basic components for heart modeling. Different hearts under different conditions have different timing parameters and/or different conduction topology. We connect node and path automata with different timing parameters into a network to represent different heart conditions. (\figref{general_setup}) 

\subsection{Interaction With The Heart Model}
In EP testing and pacemaker application, the local electrical activities, measured as electrogram (EGM) signals, are used to diagnose heart conditions. During heart model construction, we can assign a node automaton at electrode locations and the transitions to the ERP state can be used to represent the local activation events. In a more general setup where electrodes are assigned anywhere within the heart model, a probe model is designed to generate synthetic EGM signals using temporal information and spatial information from the network of node and path automata. \figref{egm} shows the morphology of EGM signal changes with different conduction velocity and probe configurations. Due to space limitation, detailed description of the probe model can be found in \cite{vhm_embc11}.

\begin{figure}[!t]
\center
%\vspace{-15pt}
		\includegraphics[width=0.45\textwidth]{figs/fig7.png}
%\vspace{-10pt}
\caption{The influence of conduction velocity and probe configuration on the EGM morphology. The left columns show the placement of probes in relation to the path; the right columns show the functional EGM.}
\label{fig:egm}
%\vspace{-15pt}
\end{figure}

\section{Non-deterministic Models for Closed-loop Model Checking}
\begin{itemize}
	\item What does nondeterminism do? Where can these model be used?
    \item How to replace complex dynamics of the deterministic models with nondeterminism?
    \item What are the abstraction rules that can be applied to the heart models and what are their physiological basis?
    \item How to encode the information loss during each abstraction steps?
\end{itemize}

\subsection{Modeling Philosophy}
\textbf{Model Formalism: }Choosing an appropriate formalism for the physiological models is important as the formalism determines the closed-loop state space and the feasibility to do model checking. Pacemaker utilize the timing of local electrical events to diagnose heart conditions. It is therefore intuitive to use timed-automata models of the heart. Timed-automata is also compatible with model checking tools like UPPAAL (\cite{uppaal_tut}) so that the whole closed-loop state space can be explored.\\
\textbf{Model Coverage: }Pacemakers are designed to treat bradycardia, however not only should the pacemakers maintain appropriate heart rate when the intrinsic rate is low, but also shall not degenerate other heart conditions. Even for the same patient the condition also changes over time that has to be taken into account. In order to achieve safety across all possible heart conditions, the heart models used during closed-loop verification should be able to cover all possible heart behaviors, more precisely, their mapping to pacemaker inputs. Over-approximation (\cite{CEGAR}) with non-determinism can be used to simplify model structure while covering larger variety of environmental behaviors. Techniques like model-checking can then be used to examine the whole closed-loop state space for property violations.\\ 
\textbf{Ambiguity Due To Low Sensing Capability: }The sensing resolution of pacemakers is low, in terms of the number of sensing location (2 leads), as well as the information obtained from each sensing location (binary events). If abstraction rules utilize the fact that different heart conditions may generate exactly the same input sequence to the pacemaker, there will be ambiguities on concretizing abstract closed-loop executions. For certain conditional requirements, it is important to differentiate all possible concrete executions corresponding to an abstract execution. As the result, the heart model(s) should have the capability to differentiate these heart conditions when verifying certain properties.\\
\textbf{Information Lose During Abstraction: }While over-approximation achieves simplicity and coverage, it also inevitably introduces invalid behaviors into the model which can cause false-negatives and false-positives during model checking. To solve this problem, more refined models of the heart should be available which can differentiate and eliminate invalid executions when necessary to avoid false-positives.

The most challenging aspect during closed-loop model checking is environment model abstraction and refinement. In \cite{STTT13} we developed a series of heart model abstractions at various abstraction levels. The models are abstracted using abstraction rules derived from physiological knowledge, thus ensuring that each abstraction step covers more physiological conditions. The models in adjacent abstraction levels also satisfy \textsf{timed-simulation} relationship (\cite{simulation}) to ensure complete coverage in the more abstract model. In the rest of the section, we briefly discuss the modeling process and the domain knowledge used. The detailed abstraction and proof for simulation relationship can be found in \cite{STTT13}.
\begin{figure}[!t]
\center
%\vspace{-10pt}
\includegraphics[width=0.9\textwidth]{figs/Heart_abs.pdf}
%\vspace{-10pt}
\caption{(a) The generation of Action potential; (b) Action potential; (c1) The second activation arrived during ERP; (c2) Arrived during RRP; (c3) Arrived after refractory. (\cite{STTT13})}
\label{fig:HM_abs}
%\vspace{-10pt}
\end{figure} 
\subsection{Initial Abstraction}
For the initial heart model, spatially we assume that every heart tissue are modeled. Temporally we model each heart tissue as an automaton $N0$ shown in \figref{HM_abs}.b. The beat-to-beat dynamics of heart tissue discussed in the last section is abstracted using non-determinism, as the ERP period and conduction delay of the tissue are non-deterministically chosen from ranges instead of deterministic functions. The model covers all possible timing behaviors of a heart tissue. 

\subsection{Abstract Conduction Delays With Paths}
At the first abstraction step, we seperate the conduction delay (modeled by the cond state in $N0$) from the new node automata $N1$ and model the conduction between two nodes using path automaton $P1$. Since the beat-to-beat dynamics are abstracted with non-determinism, the RRP state is merged with the Rest state in $N1$. 

we only model the following kinds of heart tissue with node automata and abstract other heart tissue with path automata:
\begin{itemize}
	\item Self-depolarizing tissue
    \item Tissue with long ERP period
    \item Tissue forming conduction loops
\end{itemize}

\subsection{Merging}
abstract heart tissue
% \subsubsection{Abstracting Beat-to-beat Dynamics}
% \subsubsection{Abstracting Conduction Delays with Path}
% \subsubsection{Merging Activation-generating Nodes}
% \subsubsection{Replace ERP Blocking With Non-deterministic Conduction}
% \subsubsection{Replace }


\chapter{Environment Model Identification}
\begin{itemize}
	\item Why model identification is important?
    \item How to identify?
    \item What's the data availability and quality?
    \item Are there differences for identifying different kind of models?
    \item What are the challenges?
\end{itemize}
Physiological models are developed to represent certain physiological condition in general, or the physiological condition of a specific patient. Therefore the structure of the model and corresponding parameters have to be identified. These information can be obtained from physiological data, which are from: 1) data collected during procedures, and 2) physiological literature in which physiological data are analyzed and summarized. Due to limitation on the interactions with the patient, the availability and quality of physiological data may be bad and there are not enough information to identify all the parameters in the model. It is essential to choose the right level of abstraction so that the model is identifiable (to a large extend). Having physiological correspondence for the model structure and parameters can simplify the identification process. The rigorousness of the model identification step is also an important factor for the validity of the model. 

In the following sections, we briefly discuss our model identification effort for heart models used in two closed-loop verification applications, and their corresponding challenges. 

\section{Heart Model Identification in Closed-loop Simulation}
In closed-loop simulation, a heart model should be identified to represent a specific patient under certain heart condition. The constraints for model parameters can be obtained from patient data during \emph{ElectroPhysiological (EP) Testing}. During EP testing, the physicians deliver electrical pacing sequence from electrodes placed inside the patient's heart while extracting timing parameters from observed pattern and timing of electrical events. Since the goal for any EP testing procedure is not to determine all the timing parameters for a patient, the amount of parameters that can be identified from the patient data is limited.    

An example: determine ERP and conduction delay for a two node one path heart
\section{Heart Model Identification in Closed-loop Model Checking}
In model checking, the heart models in general have simple structure and less parameters due to non-deterministic abstraction. The heart models are developed in consistent with Electrophysiology terminologies, thus each node and path automata and their timing parameters have physiological correspondence which can be found in literature (\cite{josephson}). The range for non-deterministic parameters directly correspond to the range for possible values of corresponding physiological parameters. Therefore model identification for model checking is much simpler. 

An example: \Hao{Need a photo of table of typical parameter values}







\chapter{Validate The Environment Model}
\begin{itemize}
	\item What are the different methods to validate physiological models?
    \item How much confidence can these validation provide?
\end{itemize}
The validity of the environment models affects the validity of the closed-loop verification results. Since models are always approximations of the actual environment, there is always discrepancies between the model and the actual patient (group). The challenge then is to determine how much safety guarantee that model-based closed-loop verification can provide. 

\section{Validate deterministic models}
For deterministic models there are two applications: 1) model a patient with certain heart condition, 2) model a \emph{specific} patient with certain heart condition. For the first application, it is important to show that the model successfully models the underlying mechanism of the heart condition, while for the second application the model should be able to generate same data as the corresponding patient given the same input. 

\subsection{Validating the underlying mechanism}


\begin{figure*}[!t]
\centering
		\subfigure 	[\small Testing result for a real patient (~\cite{josephson})] 
		{
		\includegraphics[width=0.45\textwidth]{figs/WB_book.pdf}
		\label{fig:book_1}
		} 
		\subfigure [\small Testing result for VHM simulation] 
		{	
			\includegraphics[width=0.40\textwidth]{figs/WB_new.pdf} 
			\label{fig:type_1}
		}
\label{fig:Case_1}
%\vspace{-5pt}
\caption{\small Key interval values when the coupling interval shortens for (a) a real patient and (b) in VHM simulation ~\cite{vhm_ecrts10}.}
%\vspace{-15pt}
\end{figure*} 

\subsection{Validating the accuracy of model identification}

% \begin{figure}[\b]
% 	\center
% 	\vspace{-20pt}
% %	\includegraphics[width=0.49\textwidth]{figs/AV_reentry_circuit.pdf}
% 	\includegraphics[width=0.5\textwidth]{figs/AFL_circuit.pdf}
% 	\center
% 	\vspace{-15pt}
% 	\caption{(a) The straight arrow shows the view of the AFL circuit from the right ventricle through the tricuspid valve into the right atrium, while the curved area shows the direction of conduction. (b) The circuit is bounded by the eustachian ridge (ER), connecting the  inferior vena cava (IVC) and the coronary sinus (CS), as well as the crista terminalis (CT), connecting the superior vena cava (SVC) and the IVC. The wavy line shows slow conduction through the CTI, bounded by the ER and the tricuspid valve (\emph{Adapted from} \cite{AFL_diag}). (c) The AFL circuit in the VHM extrapolates nodes and paths from the true physiology. The numbers show the values of conduction timers in the paths, with corresponding slow conduction path on the bottom.}
% 	\label{fig:AFL}
% \end{figure}

\section{Validate by Translating Domain Knowledge**}
For non-deterministic models
\begin{itemize}
	\item The physiological basis for the initial model come from literature
    \item All the abstraction rules follow literature
    \item Models before and after the abstraction have simulation relationships
    \item Ranges of parameters come from literature.
\end{itemize}

 
\chapter{Physiological Requirements}
\begin{itemize}
	\item How requirements are different from specifications?
    \item What are the forms of the requirements?
    \item How can the requirements be represented?
    \item Are those requirements binary?
    \item Are those requirements equally important?
\end{itemize}

% \begin{itemize}
% 	\item In contrast to specifications
%     \item Specified on physiological conditions during closed-loop interaction between the patient and the device.
%     \item Timing requirements
%     \item Monitor construction
% \end{itemize}
Physiological requirements for medical devices specify the closed-loop conditions that the devices are designed to achieve with its outputs to the patient. Unlike \emph{specifications} which specify desired device actions in response to the inputs from the patients, physiological requirements focus on the conditions of the patient with and without the device, which would indicate whether the device has fulfilled its intended goals. For example, the most basic goal for a pacemaker is to maintain the ventricular rate above certain level. The corresponding physiological requirement is:

 \emph{The interval between two ventricular contractions should always be less or equal to 1000ms.} 

Note that this requirement focus purely on the condition of the patient (ventricular contractions), and there is no mention of the operation of the pacemaker or how the pacemaker should achieve the requirement. An example specification of a single chamber pacemaker corresponding to the requirement is:  

\emph{The pacemaker should deliver ventricular pacing, if there is no sensed ventricular event 1000ms since the last ventricular event (sensed or paced).}
 
The specification is described using internal terminologies of the pacemaker software (paced and sensed events), and specified the action of the pacemaker corresponding to certain inputs. For more complex requirements, multiple specifications have to work together to achieve the requirement. Therefore there may exist executions that satisfy all the specifications but not the requirement. Verifying physiological requirements requires knowledge of the physiological condition and how device interacts with the physiological environment, thus can only be executed in closed-loop. 

Devices are designed to improve certain physiological conditions, the performance of the devices is evaluated on the difference between the patient conditions without the device and with the device. The device should also avoid deteriorating certain patient conditions, thus physiological requirements are specified in the form of:
$$C_{pre}\rightarrow C_{post}$$
in which $C_{pre}$ is the physiological conditions without the device,  and $C_{post}$ is the physiological condition with the device. For model-based closed-loop verification, $C_{pre}$ is often in form of a set of constraints on patient parameters. As a special case, $C_{pre}$ can equal to $true$, means that $C_{post}$ should be satisfied under all possible conditions.

Among all the physiological requirements for a device, not all of them are equally important. More important requirements should be given higher prioritiesAccording to the importance of the requirement

For convenience, requirements are usually specified with binary results (satisfied/unsatisfied). quantitative

hierarchical


\section{Physiological Requirements For the heart}
\begin{itemize}
	\item Conditional requirements
\end{itemize}

\section{Requirement Representations}
\subsection{TCTL}
\subsection{Simulink Block}
 
\section{Requirement Hierarchy*}


\chapter{A Dual Chamber Pacemaker Specification}
\begin{itemize}
	\item What are the basic functions?
    \item What happens if new functionalities are applied to the basic model?
\end{itemize}

\section{Basic 5 timing cycles}
\begin{figure}[!b]
\center
%\vspace{-10pt}
\includegraphics[width=0.7\textwidth]{figs/PM_timers.pdf}
%\vspace{-10pt}
\caption{Basic 5 timing cycles for a dual chamber pacemaker}
\label{fig:PMtimers}
%\vspace{-10pt}
\end{figure} 
\section{Atrial Tachycardia Response (Mode Switch)}
\begin{figure*}[!t]
\centering
		\subfigure [\small]{			
		\includegraphics[width=0.4  \textwidth]{figs/SVT_none.pdf}
		\label{fig:SVT_none}
		} 
%	\hspace{.1in}%
		
		\subfigure [\small] 
		{
		\includegraphics[width=0.4\textwidth]{figs/SVT_DDD.pdf}
		\label{fig:SVT_DDD}
		} 
%\vspace{-10pt}
\caption{\small (a) Node automaton. Dotted transition is only valid for pacemaker tissue like SA node; (b) Path automaton; (c) Model of the electrical conduction system of the heart using a network of node \& path automata~\cite{vhm_ecrts10}.}
%\vspace{-15pt}
\end{figure*} 

\section{Pacemaker Mediated Tachycardia Termination}
show need for closed-loop. open-loop inputs of this scenario

\begin{figure*}[!t]
\centering
		\subfigure [\small]{			
		\includegraphics[width=0.4  \textwidth]{figs/ELT_str.pdf}
		\label{fig:ELT_str}
		} 
%	\hspace{.1in}%
		
		\subfigure [\small] 
		{
		\includegraphics[width=0.4\textwidth]{figs/ELT.pdf}
		\label{fig:ELT}
		} 
%\vspace{-10pt}
\caption{\small (a) Node automaton. Dotted transition is only valid for pacemaker tissue like SA node; (b) Path automaton; (c) Model of the electrical conduction system of the heart using a network of node \& path automata~\cite{vhm_ecrts10}.}
%\vspace{-15pt}
\end{figure*} 


\chapter{Closed-loop Model Checking}
\begin{itemize}
	\item How to use models to cover environmental conditions specified in the physiological requirements, that the device may encounter?
            \item What are the physiological requirements? What form should they be?
            \item Can model checking find violations that testing cannot find?
            \item What are the effects of adding new features? Can they disrupt the safety properties that the previous device hold?
            \item What is the model complexity requirements for each physiological requirement? When and how to refine the environment model?
            \item Exploring the whole state space sounds great. What are the limitations of model checking? 
\end{itemize}

\section{Basic Requirements}
\section{Advanced Functions}
\subsection{Atrial Tachycardia Response}
\subsection{Endless Loop Tachycardia}
\section{Heart Model Refinements}
    
\section{Quantitative Model Checking}

\chapter{Closed-loop Model Simulation/Testing}
\begin{itemize}
	\item What are the limitations of model checking?
    \item How can simulation complement that?
\end{itemize}

\section{Crosstalk}

\section{Lead Displacement}

\chapter{Verified Model to Verified Implementation}
\begin{itemize}
        
            \item How to maintain safety confidence throughout the development process? 
            \item What is the current practice?
            \item Can it be automated?
            \item How much confidence can it provide?
\end{itemize}
\chapter{Certification}
\begin{itemize}
          	\item Can model-based closed-loop verification provide more safety guarantee than current practice? How much?
          \end{itemize}
\section{Current Practice}
\section{Model-based Proof of Confidence}
\cite{pancreas}



\backmatter





\bibliographystyle{plainnat}
\bibliography{bibliography}

\end{document}